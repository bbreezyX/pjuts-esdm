// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  FIELD_STAFF
}

enum UnitStatus {
  OPERATIONAL
  MAINTENANCE_NEEDED
  OFFLINE
  UNVERIFIED
}

// ============================================
// USER MODEL
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  role          Role      @default(FIELD_STAFF)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  reports       Report[]
  auditLogs     AuditLog[]
  lastNotificationCheck DateTime  @default(now())

  @@index([email])
  @@index([role])
  @@index([isActive])
}

// ============================================
// PJUTS UNIT MODEL (Solar Street Light Unit)
// ============================================

model PjutsUnit {
  id            String      @id @default(cuid())
  serialNumber  String      @unique
  latitude      Float
  longitude     Float
  province      String
  regency       String
  district      String?
  village       String?
  address       String?
  installDate   DateTime?
  lastStatus    UnitStatus  @default(UNVERIFIED)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  reports       Report[]

  @@index([serialNumber])
  @@index([province])
  @@index([regency])
  @@index([lastStatus])
  @@index([latitude, longitude])
}

// ============================================
// REPORT MODEL
// ============================================

model Report {
  id              String        @id @default(cuid())
  unitId          String
  unit            PjutsUnit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  // Images (Relation to new table)
  images          ReportImage[]
  
  // Field data
  batteryVoltage  Float
  latitude        Float         // GPS location when report was made
  longitude       Float
  notes           String?
  
  // Metadata
  submittedBy     String
  user            User          @relation(fields: [submittedBy], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@index([unitId])
  @@index([submittedBy])
  @@index([createdAt])
}

model ReportImage {
  id        String   @id @default(cuid())
  reportId  String
  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  url       String
  path      String   // R2 path
  createdAt DateTime @default(now())

  @@index([reportId])
}

// ============================================
// PASSWORD RESET TOKEN MODEL
// ============================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// AUDIT LOG MODEL
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // CREATE_USER, UPDATE_USER, DELETE_USER, TOGGLE_USER_STATUS, CREATE_UNIT, UPDATE_UNIT, DELETE_UNIT, DELETE_REPORT
  entityType  String   // USER, UNIT, REPORT
  entityId    String   // ID of the affected entity
  performedBy String   // ID of the user who performed the action
  performer   User     @relation(fields: [performedBy], references: [id], onDelete: Cascade)
  metadata    Json?    // Additional context (old/new values, entity details, etc.)
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([performedBy])
  @@index([createdAt])
  @@index([entityId])
}


